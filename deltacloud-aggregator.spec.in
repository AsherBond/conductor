%define app_root %{_datadir}/%{name}
%define doc_root %{_datadir}/%{name}-doc

Name:     deltacloud-aggregator
Version:  @VERSION@
Release:  0%{?dist}%{?extra_release}
Summary:  The Deltacloud Aggregator

Group:    Applications/System
License:  GPLv2+ and MIT and BSD
URL:      http://deltacloud.org

# until official source tarballs exist, checkout from source via
# git clone git://git.fedorahosted.org/deltacloud/portal.git deltacloud-aggregator-0.0.2
# tar czvf deltacloud-aggregator-0.0.2.tar.gz deltacloud-aggregator-0.0.2
Source0:    deltacloud-aggregator-%{version}.tar.gz
BuildRoot:  %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)

Requires: ruby >= 1.8.1
Requires: ruby(abi) = 1.8
Requires: rubygem(rails) >= 2.1.1
Requires: rubygem(haml)
Requires: rubygem(nokogiri) >= 1.4.0
Requires: rubygem(will_paginate)
Requires: rubygem(parseconfig)
Requires: rubygem(authlogic)
Requires: rubygem(deltacloud-client)
Requires: rubygem(gnuplot)
Requires: rubygem(scruffy)
Requires: rubygem(compass)
Requires: rubygem(compass-960-plugin)
Requires: rubygem(simple-navigation)
Requires: rubygem(typhoeus)
Requires: rubygem(rb-inotify)
Requires: rubygem(builder)
Requires: rubygem(json)
Requires: rubygem(deltacloud-image-builder-agent)
Requires: rubygem(imagebuilder-console)
Requires: postgresql
Requires: postgresql-server
Requires: ruby-postgres
Requires: gnuplot >= 4.2.6
Requires: ruby-RMagick
Requires: classads >= 1.0
Requires: condor >= 7.5.4
Requires: iwhd

BuildRequires: classads-devel >= 1.0

%package daemons
Summary:   Deltacloud Aggregator daemons config
Group:     Applications/Internet
License:   GPLv2+
Requires: %{name} = %{version}-%{release}
Requires: httpd >= 2.0
Requires: rubygem(thin) >= 1.2.5
Requires(post): chkconfig
Requires(preun): chkconfig
Requires(preun): initscripts


%package doc
Summary: Deltacloud Aggregator documentation and test suite
Group:   Documentation
Requires: %{name} = %{version}-%{release}

%description
The Aggregator for Deltacloud.

%description daemons
The configuration necessary to run and proxy the Deltacloud Aggregator.

%description doc
Documentation and tests for the Deltacloud Aggregator

%prep
%setup -q

%build
%configure
make

%install
%{__rm} -rf %{buildroot}

%{__mkdir} -p %{buildroot}
%{__mkdir} -p %{buildroot}%{app_root}
%{__mkdir} -p %{buildroot}%{doc_root}
%{__mkdir} -p %{buildroot}%{_initrddir}
%{__mkdir} -p %{buildroot}%{_sysconfdir}/sysconfig
%{__mkdir} -p %{buildroot}%{_sysconfdir}/httpd/conf.d
%{__mkdir} -p %{buildroot}%{_sysconfdir}/logrotate.d

%{__mkdir} -p %{buildroot}%{_sysconfdir}/%{name}
%{__mkdir} -p %{buildroot}%{_localstatedir}/lib/%{name}
%{__mkdir} -p %{buildroot}%{_localstatedir}/log/%{name}
%{__mkdir} -p %{buildroot}%{_localstatedir}/run/%{name}

# copy over all of the src directory...
%{__cp} -R src/* %{buildroot}/%{app_root}

# we need to make sure there are no leftover logfiles getting pulled in
rm -f %{buildroot}/%{app_root}/log/*

# Remove this directory as the make install below will install the correct files to this dir.
%{__rm} -rf %{buildroot}%{app_root}/classad_plugin

%makeinstall

# move documentation to the correct place
mv %{buildroot}/%{app_root}/doc %{buildroot}/%{app_root}/test %{buildroot}/%{doc_root}

# copy over init scripts and various config
%{__cp} conf/deltacloud-aggregator %{buildroot}%{_initrddir}
%{__cp} conf/deltacloud-dbomatic %{buildroot}%{_initrddir}
%{__cp} conf/deltacloud-condor_refreshd %{buildroot}%{_initrddir}
%{__cp} conf/deltacloud-image_builder_service %{buildroot}%{_initrddir}
%{__cp} conf/deltacloud-portal.conf %{buildroot}%{_sysconfdir}/httpd/conf.d/deltacloud-aggregator.conf
%{__cp} conf/deltacloud-portal.logrotate %{buildroot}%{_sysconfdir}/logrotate.d/deltacloud-aggregator
%{__cp} conf/deltacloud-aggregator.sysconf %{buildroot}%{_sysconfdir}/sysconfig/deltacloud-aggregator
%{__cp} conf/deltacloud-rails.sysconf %{buildroot}%{_sysconfdir}/sysconfig/deltacloud-rails

# move rails config to /etc, creating symlinks
if [ -f %{buildroot}%{app_root}/config/database.yml ]; then
   %{__mv} %{buildroot}%{app_root}/config/database.yml %{buildroot}%{_sysconfdir}/%{name}
else
   %{__cp} %{buildroot}%{app_root}/config/database.pg %{buildroot}%{_sysconfdir}/%{name}/database.yml
fi
%{__mv} %{buildroot}%{app_root}/config/environments/development.rb %{buildroot}%{_sysconfdir}/%{name}
%{__mv} %{buildroot}%{app_root}/config/environments/production.rb %{buildroot}%{_sysconfdir}/%{name}
%{__mv} %{buildroot}%{app_root}/config/environments/test.rb %{buildroot}%{_sysconfdir}/%{name}
%{__ln_s} %{_sysconfdir}/%{name}/database.yml %{buildroot}%{app_root}/config
%{__ln_s} %{_sysconfdir}/%{name}/development.rb %{buildroot}%{app_root}/config/environments
%{__ln_s} %{_sysconfdir}/%{name}/production.rb %{buildroot}%{app_root}/config/environments
%{__ln_s} %{_sysconfdir}/%{name}/test.rb %{buildroot}%{app_root}/config/environments
%{__mkdir} %{buildroot}%{app_root}/config/image_descriptor_xmls

# Creating these files now to make sure the logfiles will be owned
# by dcloud:dcloud. This is a temporary workaround while we've still
# got root-owned daemon processes. Once we resolve that issue
# these files will no longer be added explicitly here.
touch %{buildroot}%{_localstatedir}/log/%{name}/mongrel.log
touch %{buildroot}%{_localstatedir}/log/%{name}/rails.log
touch %{buildroot}%{_localstatedir}/log/%{name}/dbomatic.log
touch %{buildroot}%{_localstatedir}/run/%{name}/event_log_position
touch %{buildroot}%{_localstatedir}/log/%{name}/condor_refreshd.log
touch %{buildroot}%{_localstatedir}/log/%{name}/image_builder_service.log

# remove the files not needed for the installation
%{__rm} -f  %{buildroot}%{app_root}/vendor/plugins/will_paginate/.gitignore
%{__rm} -f  %{buildroot}%{app_root}/vendor/plugins/will_paginate/.manifest

%{__rm} -rf %{buildroot}%{app_root}/tmp
%{__mkdir} %{buildroot}%{_localstatedir}/lib/%{name}/tmp
%{__ln_s} %{_localstatedir}/lib/%{name}/tmp %{buildroot}%{app_root}/tmp

%{__rm} -rf %{buildroot}%{app_root}/tmp

# Delete unused build stuff.
%{__rm} -rf %{buildroot}%{app_root}/classad_plugin/.libs
%{__rm} -rf %{buildroot}%{app_root}/classad_plugin/.deps

%clean
%{__rm} -rf %{buildroot}

#%check
#rake spec

%pre daemons
getent group dcloud >/dev/null || /usr/sbin/groupadd -g 109 -r dcloud 2>/dev/null || :
getent passwd dcloud >/dev/null || \
    /usr/sbin/useradd -u 109 -g dcloud -c "dcloud" \
    -s /sbin/nologin -r -d /var/dcloud dcloud 2> /dev/null || :

%post daemons
# Register the services
/sbin/chkconfig --add deltacloud-aggregator
/sbin/chkconfig --add deltacloud-dbomatic
/sbin/chkconfig --add deltacloud-condor_refreshd
/sbin/chkconfig --add deltacloud-image_builder_service

%preun daemons
if [ $1 = 0 ]; then
/sbin/service deltacloud-aggregator stop > /dev/null 2>&1
/sbin/chkconfig --del deltacloud-aggregator
/sbin/service deltacloud-dbomatic stop > /dev/null 2>&1
/sbin/chkconfig --del deltacloud-dbomatic
/sbin/service deltacloud-condor_refreshd stop > /dev/null 2>&1
/sbin/chkconfig --del deltacloud-condor_refreshd
/sbin/service deltacloud-image_builder_service stop > /dev/null 2>&1
/sbin/chkconfig --del deltacloud-image_builder_service
fi

%files
%defattr(-,root,root,-)
%{app_root}
%attr(777, root, root) %{app_root}/config/image_descriptor_xmls
%attr(777, root, root) %{app_root}/public
%dir %{_sysconfdir}/%{name}
%config(noreplace) %{_sysconfdir}/%{name}/database.yml
%config(noreplace) %{_sysconfdir}/%{name}/development.rb
%config(noreplace) %{_sysconfdir}/%{name}/production.rb
%config(noreplace) %{_sysconfdir}/%{name}/test.rb
%doc AUTHORS COPYING

%files daemons
%defattr(-,root,root,-)
%{_initrddir}/deltacloud-aggregator
%{_initrddir}/deltacloud-dbomatic
%{_initrddir}/deltacloud-condor_refreshd
%{_initrddir}/deltacloud-image_builder_service
%config(noreplace) %{_sysconfdir}/logrotate.d/%{name}
%config(noreplace) %{_sysconfdir}/sysconfig/deltacloud-aggregator
%config(noreplace) %{_sysconfdir}/sysconfig/deltacloud-rails
%config(noreplace) %{_sysconfdir}/httpd/conf.d/%{name}.conf
%attr(-, dcloud, dcloud) %{_localstatedir}/lib/%{name}
%attr(-, dcloud, dcloud) %{_localstatedir}/run/%{name}
%attr(-, dcloud, dcloud) %{_localstatedir}/log/%{name}
%doc AUTHORS COPYING

%files doc
%defattr(-,root,root,-)
%{doc_root}
%doc AUTHORS COPYING

%changelog
* Mon Sep 27 2010 Chris Lalancette <clalance@redhat.com>
- Added new rubygem-parseconfig dependency
- Turn on services during install with chkconfig

* Sat Mar 6 2010 Ian Main <imain@redhat.com> - 0.0.2-2
- removed taskomatic from packaging.

* Wed Feb 18 2010 Mohammed Morsi <mmorsi@redhat.com> - 0.0.2-1
- renamed portal to aggregator
- updated / cleaned up package

* Fri Sep  1 2009  <sseago@redhat.com> - 0.0.1-1
- Initial build.

