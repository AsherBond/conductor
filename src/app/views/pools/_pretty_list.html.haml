%header
  %h2=t 'pools.index.your_pools'
  %span.label.badge.dark.count= @pools.total_entries

.content#pools-list
  - @pools.each do |pool|
    %div.pool.overview{:id => ['pool', pool.id], :class => ('collapsed' unless pool.deployments.count > 0)}
      %header{:class => "pool-header-#{pool.id}"}
        %h3.name
          = link_to pool.name, pool
        %dl.statistics
          %ul.groups
            %li
              %dt=t 'deployments.deployments'
              %dd.count.deployment= pool.deployments.count
            %li
              %dt=t 'instances.instances.other'
              %dd.count.instance= pool.instances.count
              %dd.count.instance.pending= pool.instances.select {|i| i.state == Instance::STATE_PENDING }.length
              %dd.count.instance.failure= pool.instances.select {|i| i.state == Instance::STATE_ERROR || i.state == Instance::STATE_CREATE_FAILED }.length
            %li
              %dt=t'quota_used'
              %dd.percentage.quota
                = number_to_percentage(pool.quota.percentage_used, :precision => 0)
        %a.control{:href => '#'}
          %span Expand/Collapse
      %div.content
        - deployments = pool.deployments.list_for_user(current_user, Privilege::VIEW).ascending_by_name.paginate(:page => params[:page], :per_page => PER_PAGE)
        = render :partial => 'deployments', :locals => {:pool => pool, :deployments => deployments}
      %ul.content.actions
        %li
          - pool_details_label = deployments.total_pages > 1 ? t('pools.index.not_all_deployments_displayed_alert_html', :name => pool.name) : t('pools.index.pool_details_html', :name => pool.name)
          = link_to(pool_details_label, pool_path(pool), :class =>'pool_details')
        %li
          - if check_privilege(Privilege::CREATE, Deployment, pool)
            = link_to t('deployments.new_deployment'), launch_new_deployments_path(:pool_id => pool.id), :class => 'button primary', :id => 'new_deployment_button'
        %li.catalog_link
          = render :partial => 'layouts/catalog_dropdown', :locals => {:catalogs => pool.catalogs}

  = render_pagination(@pools)

:javascript
  $(document).ready(function() {
    $('div.pool').each(function(){
      var this_pool = this;
      $(this).find('header a.control').click(function(){
        $(this_pool).toggleClass('collapsed');
        return false;
      });
    })
  });

%script#deploymentPrettyTemplate{ :type => 'text/x-jquery-tmpl' }
  :plain
    <li class="deployment">
      <h3 class="name">
        <a href="#{deployment_path('replace_id').sub('replace_id', '${id}')}">${name}</a>
      </h3>
      <span class="status ${status}" title="${status_description}">${status}</span>
      <dl class="statistics">
        <ul>
          <li class="right">
            <dt class="instances count">#{t 'instances.instances.other'}</dt>
            <dd>${instances_count}</dd>
          </li>
          <li class="left">
            <dt>#{t :uptime}</dt>
            <dd>${uptime}</dd>
          </li>
        </ul>
      </dl>
    </li>

%script#poolPrettyListHeaderTemplate{ :type => 'text/x-jquery-tmpl' }
  :plain
    <h3 class="name">
      <a href="#{pool_path('replace_id').sub('replace_id', '${id}')}">${name}</a>
    </h3>
    <dl class="statistics">
      <ul class="groups">
        <li>
          <dt>#{t 'deployments.deployments'}</dt>
          <dd class="count deployment">${deployments_count}</dd>
        </li>
        <li>
          <dt>#{t 'instances.instances.other'}</dt>
          <dd class="count instance">${statistics.total_instances}</dd>
          <dd class="count instance pending">${statistics.instances_pending}</dd>
          <dd class="count instance failure">${statistics.instances_failed_count}</dd>
        </li>
        <li>
          <dt>#{t 'quota_used'}</dt>
          <dd class="percentage_quota">${statistics.quota_percent}</dd>
        </li>
      </ul>
    </dl>
    <a class="control" href="#">
      <span>Expand/Collapse</span>
    </a>
